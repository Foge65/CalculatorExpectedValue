<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FS Profit Calc</title>
    <link rel="stylesheet" href="css.css">
</head>

<body>

<div id="rooms">
    <a>Room:</a>
    <label for="room"></label>
    <select id="room" onchange="setValueOnChange('/setRoom', 'room', this)"></select>
</div>

<div id="buyIns">
    <a>BuyIn:</a>
    <label for="buyIn"></label>
    <select id="buyIn" onchange="setValueOnChange('/setBuyIn', 'buyIn', this)"></select>
</div>

<div id="rakes">
    <a>Rake:</a>
    <label for="rake"></label>
    <select id="rake" onchange="setValueOnChange('/setRake', 'rake', this)"></select>
</div>

<a class="inline">Tournaments:</a>
<label for="tournaments"></label>
<input type="text" id="tournaments" oninput="setValueOnInput('tournaments', '/setTournaments', 'tourney')">
<p id="outputTournaments"></p>

<a class="inline">ChipsEV:</a>
<label for="chipsEV"></label>
<input type="text" id="chipsEV" oninput="setValueOnInput('chipsEV', '/setChipsEV', 'chipsEV')">
<p id="outputChipsEV"></p>

<a class="inline">RackBack:</a>
<label for="rakeBack"></label>
<input type="text" id="rakeBack" oninput="setValueOnInput('rakeBack', '/setRakeBack', 'rakeBack')">
<p id="outputRakeBack"></p>

<a class="inline">Tables:</a>
<label for="tables"></label>
<input type="text" id="tables" oninput="setValueOnInput('tables', '/setTables', 'tables')">
<p id="outputTables"></p>

<a class="inline">TablesPerHour:</a>
<label for="tablesPerHour"></label>
<input type="text" id="tablesPerHour" oninput="setValueOnInput('tablesPerHour', '/setTablesPerHour', 'tables')">
<p id="outputTablesPerHour"></p>

<a class="inline">HyperEV:</a>
<label for="hyperEV"></label>
<input type="text" id="hyperEV" readonly>
<p id="outputHyperEV"></p>

<script>
    getData('/getRooms', param => {
        listElements(param, "room");

        document.getElementById("room").selectedIndex = 0;
        setValueOnChange('/setRoom', 'room', document.getElementById("room"));
    });

    getData('/getBuyIns', param => {
        listElements(param, "buyIn");

        document.getElementById("buyIn").selectedIndex = 0;
        setValueOnChange('/setBuyIn', 'buyIn', document.getElementById("buyIn"));
    });

    getData('/getRakes', param => {
        listElements(param, "rake");

        document.getElementById("rake").selectedIndex = 0;
        setValueOnChange('/setRake', 'rake', document.getElementById("rake"));
    });

    function getData(url, callback) {
        let request = new XMLHttpRequest();
        request.onreadystatechange = () => {
            if (request.readyState === XMLHttpRequest.DONE) {
                if (request.status === 200) {
                    let data = JSON.parse(request.responseText);
                    callback(data);
                } else {
                    console.error('Error received ' + url + ": ", request.status);
                }
            }
        };
        request.open('GET', url, true);
        request.send();
    }

    function listElements(data, id) {
        let element = document.getElementById(id);
        data.forEach(item => {
            let option = document.createElement("option");
            option.value = item;
            option.textContent = item;
            element.appendChild(option);
        });
    }

    function setValueOnChange(request, requestParam, value) {
        let url = `${request}?${requestParam}=${encodeURIComponent(value.value)}`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(() => {
                getValue('/hyperEV', 'hyperEV');
            });
    }

    function setValueOnInput(id, request, requestParam) {
        let value = document.getElementById(id).value;
        if (/^\d*\.?\d*$/.test(value)) {
            let form = new FormData();
            form.append(requestParam, value);

            fetch(request, {
                method: 'POST',
                body: form
            }).then(() => {
                getValue('/hyperEV', 'hyperEV');
            });
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        getValue('/hyperEV', 'hyperEV');
    });

    function getValue(request, id) {
        fetch(request)
            .then(response => response.text())
            .then(data => {
                document.getElementById(id).value = data;
            })
            .catch(error => {
                console.error('Error received: ', error);
            });
    }

</script>
</body>
</html>
