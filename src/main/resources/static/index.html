<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FS Profit Calc</title>
    <link rel="stylesheet" href="css.css">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
<body>

<div class="table-container">
    <table>
        <caption><h3>Знаю свой $/час</h3></caption>
        <tr>
            <td>
                <div>
                    <a>Лимит:</a>
                    <select id="buyIn1" onchange="setValueOnChange('/calcEV/setBuyIn', 'buyIn', this)"></select>
                </div>

                <div>
                    <a>$/Час:</a>
                    <input id="dollarsPerHour1"
                           oninput="setValueOnInput('dollarsPerHour1', '/calcEV/setDollarsPerHour', 'dollars')">
                </div>

                <div>
                    <a>Рабочих часов в день:</a>
                    <input id="hoursPerDay1"
                           oninput="setValueOnInput('hoursPerDay1', '/calcEV/setHoursPerDay', 'hours')">
                </div>

                <div>
                    <a>Рабочих дней в месяц:</a>
                    <input id="daysPerMonth1"
                           oninput="setValueOnInput('daysPerMonth1', '/calcEV/setDaysPerMonth', 'days')">
                </div>

                <div>
                    <a><b>$EV Total (общий профит):</b></a>
                    <input id="dollarEVTotal1" readonly>
                </div>

                <div>
                    <a><b>EV BI:</b></a>
                    <input id="evBI1" readonly>
                </div>

                <div>
                    <a>Откатная сетка:</a>
                    <select id="mesh1" onchange="setValueOnChange('/calcEV/setMesh', 'mesh', this)"></select>
                </div>

                <div>
                    <a><b>Доля игрока, %:</b></a>
                    <input id="playerWinPercent1" readonly>
                </div>

                <div>
                    <a><b>Доля игрока, $:</b></a>
                    <input id="playerWinMoney1" readonly>
                </div>
            </td>
        </tr>
    </table>

    <table>
        <caption><h3>Знаю свой тотал рейкбек</h3></caption>
        <tr>
            <td>
                <div>
                    <a>Рум:</a>
                    <select id="room2" onchange="setValueOnChange('/calcEV/setRoom', 'room', this)"></select>
                </div>

                <div>
                    <a>Лимит:</a>
                    <select id="buyIn2" onchange="setValueOnChange('/calcEV/setBuyIn', 'buyIn', this)"></select>
                </div>

                <div>
                    <a>ChipsEV/Tourney:</a>
                    <input id="chipsEV2"
                           oninput="setValueOnInput('chipsEV2', '/calcEV/setChipsEVFromTourney', 'chips')">
                </div>

                <div>
                    <a>$EV/Tourney:</a>
                    <input id="dollarsEVPerTourney2"
                           oninput="setValueOnInput('dollarsEVPerTourney2', '/calcEV/setDollarsEVPerTourney', 'dollars')">
                </div>

                <div>
                    <a>RackBack Total, %:</a>
                    <input id="rakeBackTotal2"
                           oninput="setValueOnInput('rakeBackTotal2', '/calcEV/setRakeBackTotal', 'rakeBack')">
                </div>

                <div>
                    <a><b>$EV Total / Tourney:</b></a>
                    <input id="dollarEVTotalFromTourney2" readonly type="text">
                </div>

                <div>
                    <a>Дистанция за период:</a>
                    <input id="tourneyPerPeriod2"
                           oninput="setValueOnInput('tourneyPerPeriod2', '/calcEV/setTourneyPerPeriod', 'tourney')">
                </div>

                <div>
                    <a><b>$EV Total (Общий профит):</b></a>
                    <input id="dollarEVTotal2" readonly>
                </div>

                <div>
                    <a><b>EV BI:</b></a>
                    <input id="evBI2" readonly>
                </div>

                <div id="meshs2">
                    <a>Откатная сетка:</a>
                    <select id="mesh2" onchange="setValueOnChange('/calcEV/setMesh', 'mesh', this)"></select>
                </div>

                <div>
                    <a><b>Доля игрока, %:</b></a>
                    <input id="playerWinPercent2" readonly>
                </div>

                <div>
                    <a><b>Доля игрока, $:</b></a>
                    <input id="playerWinMoney2" readonly>
                </div>
            </td>
        </tr>
    </table>

    <table>
        <caption><h3>Не знаю свой тотал рейкбек</h3></caption>
        <tr>
            <td>
                <div>
                    <a>Рум:</a>
                    <select id="room3" onchange="setValueOnChange('/calcEV/setRoom', 'room', this)"></select>
                </div>

                <div>
                    <a>Лимит:</a>
                    <select id="buyIn3" onchange="setValueOnChange('/calcEV/setBuyIn', 'buyIn', this)"></select>
                </div>

                <div>
                    <a>ChipsEV/Tourney:</a>
                    <input id="chipsEV3"
                           oninput="setValueOnInput('chipsEV3', '/calcEV/setChipsEVFromTourney', 'chips')">
                </div>

                <div>
                    <a>$EV/Tourney:</a>
                    <input id="dollarsEVPerTourney3"
                           oninput="setValueOnInput('dollarsEVPerTourney3', '/calcEV/setDollarsEVPerTourney', 'dollars')">
                </div>

                <div>
                    <a>Дистанция в день:</a>
                    <input id="tourneyPerDay3"
                           oninput="setValueOnInput('tourneyPerDay3', '/calcEV/setTourneyPerDay', 'tourney')">
                </div>

                <div>
                    <a>Выплаты RB в день, $:</a>
                    <input id="rakeBackDollarsPerDay3"
                           oninput="setValueOnInput('rakeBackDollarsPerDay3', '/calcEV/setRakeBackDollarsPerDay', 'payments')">
                </div>

                <div>
                    <a><b>%RB в день:</b></a>
                    <input id="rakeBackPercentPerDay3" readonly>
                </div>

                <div>
                    <a>Игровых дней в неделю:</a>
                    <input id="daysPerWeek3"
                           oninput="setValueOnInput('daysPerWeek3', '/calcEV/setDaysPerWeek', 'days')">
                </div>

                <div>
                    <a><b>Дистанция в неделю:</b></a>
                    <input id="tourneyPerWeek3" readonly>
                </div>

                <div>
                    <a>Выплаты RB в неделю, $:</a>
                    <input id="rakeBackDollarsPerWeek3"
                           oninput="setValueOnInput('rakeBackDollarsPerWeek3', '/calcEV/setRakeBackDollarsPerWeek', 'payments')">
                </div>

                <div>
                    <a><b>%RB в неделю:</b></a>
                    <input id="rakeBackPercentPerWeek3" readonly>
                </div>

                <div>
                    <a>Игровых недель в период:</a>
                    <input id="weeksPerPeriod3"
                           oninput="setValueOnInput('weeksPerPeriod3', '/calcEV/setWeeksPerPeriod', 'weeks')">
                </div>

                <div>
                    <a><b>Дистанция за период:</b></a>
                    <input id="tourneyPerPeriod3" readonly>
                </div>

                <div>
                    <a>Выплаты RB в период, $:</a>
                    <input id="rakeBackDollarsPerPeriod3"
                           oninput="setValueOnInput('rakeBackDollarsPerPeriod3', '/calcEV/setRakeBackDollarsPerPeriod', 'dollars')">
                </div>

                <div>
                    <a><b>RackBack за период, %:</b></a>
                    <input id="rakeBackPercentPerPeriod3" readonly>
                </div>

                <div>
                    <a><b>RackBack Total, %:</b></a>
                    <input id="rakeBackPercentTotal3" readonly>
                </div>

                <div>
                    <a><b>$EV Total/Tourney:</b></a>
                    <input id="dollarEVTotalPerTourney3" readonly>
                </div>

                <div>
                    <a><b>$EV Total (Общий профит):</b></a>
                    <input id="dollarEVTotal3" readonly>
                </div>

                <div>
                    <a><b>EV BI:</b></a>
                    <input id="evBI3" readonly>
                </div>

                <div id="meshs3">
                    <a>Откатная сетка:</a>
                    <select id="mesh3" onchange="setValueOnChange('/calcEV/setMesh', 'mesh', this)"></select>
                </div>

                <div>
                    <a><b>Доля игрока, %:</b></a>
                    <input id="playerWinPercent3" readonly>
                </div>

                <div>
                    <a><b>Доля игрока, $:</b></a>
                    <input id="playerWinMoney3" readonly>
                </div>
            </td>
        </tr>
    </table>
</div>

<script>
    const setFields = [
        'dollarsPerHour1',
        'hoursPerDay1',
        'daysPerMonth1',
        'chipsEV2',
        'dollarsEVPerTourney2',
        'rakeBackTotal2',
        'tourneyPerPeriod2',
        'chipsEV3',
        'dollarsEVPerTourney3',
        'tourneyPerDay3',
        'rakeBackDollarsPerDay3',
        'daysPerWeek3',
        'rakeBackDollarsPerWeek3',
        'weeksPerPeriod3',
        'rakeBackDollarsPerPeriod3'
    ];

    function setValueOnInput(id, request, requestParam) {
        let value = document.getElementById(id).value;
        if (value.trim() !== '' && /^\d*\.?\d*$/.test(value)) {
            let form = new FormData();
            form.append(requestParam, value);

            fetch(request, {
                method: 'POST',
                body: form
            }).then(() => {
                addToListener();
            });
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        setDefaultValue();

        getData('/calcEV/getRooms', data => {
            buildList(data, "room2");
            setValueOnChange('/calcEV/setRoom', 'room', document.getElementById("room2"));
        });

        getData('/calcEV/getRooms', data => {
            buildList(data, "room3");
            setValueOnChange('/calcEV/setRoom', 'room', document.getElementById("room3"));
        });

        getData('/calcEV/getBuyIns', data => {
            buildList(data, "buyIn1");
            setValueOnChange('/calcEV/setBuyIn', 'buyIn', document.getElementById("buyIn1"));
        });

        getData('/calcEV/getBuyIns', data => {
            buildList(data, "buyIn2");
            setValueOnChange('/calcEV/setBuyIn', 'buyIn', document.getElementById("buyIn2"));
        });

        getData('/calcEV/getBuyIns', data => {
            buildList(data, "buyIn3");
            setValueOnChange('/calcEV/setBuyIn', 'buyIn', document.getElementById("buyIn3"));
        });

        getData('/calcEV/getMeshes', data => {
            buildList(data, "mesh1");
            setValueOnChange('/calcEV/setMesh', 'mesh', document.getElementById("mesh1"));
        });

        getData('/calcEV/getMeshes', data => {
            buildList(data, "mesh2");
            setValueOnChange('/calcEV/setMesh', 'mesh', document.getElementById("mesh2"));
        });

        getData('/calcEV/getMeshes', data => {
            buildList(data, "mesh3");
            setValueOnChange('/calcEV/setMesh', 'mesh', document.getElementById("mesh3"));
        });

        addToListener();

        let roomSelect2 = document.getElementById("room2");
        let roomSelect3 = document.getElementById("room3");

        roomSelect2.addEventListener("change", () => {
            updateBuyInsForRoom(roomSelect2.value, "buyIn2");
        });

        roomSelect3.addEventListener("change", () => {
            updateBuyInsForRoom(roomSelect3.value, "buyIn3");
        });
    });

    function updateBuyInsForRoom(room, buyInId) {
        let buyInSelect = document.getElementById(buyInId);
        buyInSelect.innerHTML = "";

        getData(`/calcEV/getBuyIns?room=${encodeURIComponent(room)}`, data => {
            buildList(data, buyInId);
            setValueOnChange('/calcEV/setBuyIn', 'buyIn', buyInSelect);
        });
    }

    function setDefaultValue() {
        setFields.forEach(element => {
            const field = document.getElementById(element);
            field.value = "0";
        });
    }

    function addToListener() {
        getValueById('/calcEV/dollarEVTotal', 'dollarEVTotal1');
        getValueById('/calcEV/evBI', 'evBI1');

        getValueById('/calcEV/dollarEVTotalFromTourney', 'dollarEVTotalFromTourney2');
        getValueById('/calcEV/dollarEVTotal', 'dollarEVTotal2');
        getValueById('/calcEV/evBI', 'evBI2');

        getValueById('/calcEV/getRakeBackPercentPerDay', 'rakeBackPercentPerDay3');
        getValueById('/calcEV/getTourneyPerWeek', 'tourneyPerWeek3');
        getValueById('/calcEV/getRakeBackPercentPerWeek', 'rakeBackPercentPerWeek3');
        getValueById('/calcEV/getTourneyPerPeriod', 'tourneyPerPeriod3');
        getValueById('/calcEV/getRakeBackPercentPerPeriod', 'rakeBackPercentPerPeriod3');
        getValueById('/calcEV/getRakeBackPercentTotal', 'rakeBackPercentTotal3');
        getValueById('/calcEV/getDollarEVTotalPerTourney', 'dollarEVTotalPerTourney3');
        getValueById('/calcEV/dollarEVTotal', 'dollarEVTotal3');
        getValueById('/calcEV/evBI', 'evBI3');
    }

    function getData(url, callback) {
        let request = new XMLHttpRequest();
        request.onreadystatechange = () => {
            if (request.readyState === XMLHttpRequest.DONE) {
                let data = JSON.parse(request.responseText);
                callback(data);
            }
        };
        request.open('GET', url, true);
        request.send();
    }

    function buildList(data, id) {
        let element = document.getElementById(id);
        data.forEach(item => {
            let option = document.createElement("option");
            option.value = item;
            option.textContent = item;
            element.appendChild(option);
        });
    }

    function setValueOnChange(request, requestParam, value) {
        let url = `${request}?${requestParam}=${encodeURIComponent(value.value)}`;
        fetch(url, {
            method: 'POST',
        }).then(() => {
            addToListener();
        });
    }

    function getValueById(request, id) {
        fetch(request)
            .then(response => response.text())
            .then(data => {
                document.getElementById(id).value = data;
            })
    }

</script>
</body>
</html>
